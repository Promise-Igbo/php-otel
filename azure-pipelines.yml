trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'managedservice'       # Your Azure service connection
  appName: 'laravel-new'                    # Azure App Service name
  phpVersion: '8.2'                         # PHP version
  artifactName: 'drop'                      

stages:
# ========================
# BUILD STAGE
# ========================
- stage: Build
  displayName: Build Laravel App
  jobs:
    - job: Build
      pool:
        vmImage: ubuntu-latest

      steps:
        # 1️⃣ Checkout code
        - checkout: self

        # 2️⃣ Install PHP 8.2 and required extensions
        - script: |
            sudo apt update
            sudo apt install php8.2 php8.2-cli php8.2-mbstring php8.2-xml php8.2-curl unzip -y
            php -v
          displayName: Install PHP 8.2

        # 3️⃣ Install Composer dependencies
        - script: |
            composer install --no-dev --prefer-dist --optimize-autoloader
          displayName: Install Composer Dependencies

        # 4️⃣ Create .env if missing
        - script: |
            if [ ! -f .env ]; then
              cp .env.example .env
            fi
          displayName: Ensure .env Exists

        # 5️⃣ Generate Laravel app key and optimize
        - script: |
            php artisan key:generate --force
            php artisan view:clear
            php artisan optimize
          displayName: Laravel Optimization

        # 6️⃣ Archive the project for deployment
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
            includeRootFolder: false
            archiveType: zip
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
            replaceExistingArchive: true

        # 7️⃣ Publish artifact to pipeline
        - publish: '$(Build.ArtifactStagingDirectory)'
          artifact: $(artifactName)

# ========================
# DEPLOY STAGE
# ========================
- stage: Deploy
  displayName: Deploy to Azure App Service
  dependsOn: Build
  jobs:
    - deployment: Deploy
      environment: production
      pool:
        vmImage: ubuntu-latest

      strategy:
        runOnce:
          deploy:
            steps:
              # 1️⃣ Download the build artifact
              - download: current
                artifact: $(artifactName)

              # 2️⃣ Deploy to Azure App Service (Linux)
              - task: AzureWebApp@1
                displayName: Deploy to App Service
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: webAppLinux
                  appName: '$(appName)'
                  package: '$(Pipeline.Workspace)/$(artifactName)/$(artifactName).zip'
