trigger:
  branches:
    include:
      - main

pr: none

pool:
  vmImage: ubuntu-latest

variables:
  phpVersion: '8.3'
  artifactName: 'php-app'
  azureServiceConnection: 'leah2-connection'
  webAppName: 'new-otel'

stages:
# =========================
# BUILD STAGE
# =========================
- stage: Build
  displayName: Build PHP App
  jobs:
    - job: Build
      displayName: Build
      steps:
        - checkout: self

        - task: UsePHPVersion@0
          displayName: 'Use PHP $(phpVersion)'
          inputs:
            versionSpec: '$(phpVersion)'

        - script: |
            if [ -f composer.json ]; then
              composer validate --no-check-publish
              composer install --prefer-dist --no-progress --ignore-platform-req=ext-opentelemetry
            else
              echo "composer.json not found, skipping composer install"
            fi
          displayName: 'Install PHP dependencies'

        - task: PublishPipelineArtifact@1
          displayName: 'Publish build artifact'
          inputs:
            targetPath: '$(System.DefaultWorkingDirectory)'
            artifact: '$(artifactName)'

# =========================
# DEPLOY STAGE
# =========================
- stage: Deploy
  displayName: Deploy to Azure App Service
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployWeb
      displayName: Deploy PHP App
      environment: production
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadPipelineArtifact@2
                displayName: 'Download build artifact'
                inputs:
                  artifact: '$(artifactName)'
                  path: '$(Pipeline.Workspace)'

              - task: AzureWebApp@1
                displayName: 'Deploy to Azure Web App'
                inputs:
                  azureSubscription: '$(azureServiceConnection)'
                  appType: 'webAppLinux'
                  appName: '$(webAppName)'
                  package: '$(Pipeline.Workspace)/$(artifactName)'
